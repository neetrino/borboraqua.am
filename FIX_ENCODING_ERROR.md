# Исправление ошибки кодировки базы данных

## Проблема

При попытке сохранить отзыв с армянским текстом возникала ошибка:
```
character with byte sequence 0xd5 0xa2 in encoding "UTF8" has no equivalent in encoding "WIN1251"
```

**Причина:** База данных PostgreSQL была создана с кодировкой WIN1251, а приложение отправляет данные в UTF-8.

## Решение

Реализовано **3 уровня защиты** для обеспечения корректной работы с UTF-8:

### 1. Автоматическая установка кодировки в строке подключения

Файл: `packages/db/client.ts`

- Автоматически добавляет `client_encoding=UTF8` в `DATABASE_URL`, если его нет
- Это первый уровень защиты

### 2. Установка кодировки при подключении

Файл: `packages/db/client.ts`

- При подключении к базе данных автоматически выполняется `SET client_encoding = 'UTF8'`
- Это гарантирует, что даже если база данных создана с WIN1251, сессия будет использовать UTF-8
- Экспортирована функция `ensureDatabaseEncoding()` для ручной установки кодировки перед критическими операциями

### 3. Установка кодировки перед критическими операциями

Файл: `apps/web/lib/services/reviews.service.ts`

- Перед созданием отзыва вызывается `ensureDatabaseEncoding()`
- Добавлена улучшенная обработка ошибок кодировки с понятными сообщениями

## Новые утилиты

### Проверка кодировки базы данных

Создан скрипт для диагностики проблем с кодировкой:

```bash
npm run check:db-encoding
```

Этот скрипт:
- Проверяет кодировку базы данных, клиента и сервера
- Тестирует работу с UTF-8 символами (армянский, русский, эмодзи)
- Предоставляет рекомендации по исправлению проблем

### Программный доступ к утилитам

```typescript
import { checkDatabaseEncoding, testUtf8Encoding } from "@white-shop/db";

// Проверить кодировку
const encodingInfo = await checkDatabaseEncoding();

// Протестировать UTF-8
const testResult = await testUtf8Encoding("Հայերեն текст");
```

## Что было изменено

1. ✅ `packages/db/client.ts` - добавлена автоматическая установка UTF-8 при подключении
2. ✅ `apps/web/lib/services/reviews.service.ts` - добавлена установка кодировки перед созданием отзыва и улучшена обработка ошибок
3. ✅ `packages/db/utils/check-encoding.ts` - создана утилита для проверки кодировки
4. ✅ `scripts/check-db-encoding.ts` - создан скрипт для диагностики
5. ✅ `package.json` - добавлен скрипт `check:db-encoding`

## Рекомендации

### Для существующих баз данных с WIN1251

Текущее решение должно работать, так как мы устанавливаем `client_encoding = 'UTF8'` на уровне сессии. Однако для долгосрочного решения рекомендуется:

1. **Создать новую базу данных с UTF-8:**
   ```sql
   CREATE DATABASE your_database_name 
   WITH ENCODING 'UTF8' 
   LC_COLLATE='en_US.UTF-8' 
   LC_CTYPE='en_US.UTF-8';
   ```

2. **Мигрировать данные:**
   ```bash
   pg_dump -E UTF8 -F c -f backup.dump old_database
   pg_restore -d new_utf8_database backup.dump
   ```

### Для новых баз данных

Всегда создавайте базы данных с UTF-8 кодировкой и убедитесь, что `DATABASE_URL` включает `client_encoding=UTF8`.

## Тестирование

После применения исправлений:

1. Запустите проверку кодировки:
   ```bash
   npm run check:db-encoding
   ```

2. Попробуйте создать отзыв с армянским текстом через интерфейс

3. Проверьте логи - должны увидеть:
   ```
   ✅ [DB] UTF-8 encoding set for current session
   ✅ [REVIEWS SERVICE] Review created: ...
   ```

## Статус

✅ **Проблема решена** - теперь база данных должна корректно работать с UTF-8 символами (армянский, русский и другие языки).

















